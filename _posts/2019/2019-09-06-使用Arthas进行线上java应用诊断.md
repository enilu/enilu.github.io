---
layout: post
category : linux
keywords : "Arthas,java应用诊断"
description : "使用alibaba Arthas进行线上java应用诊断"
tags : [运维,java]
---

 最近发现一个挺好用的工具：alibaba出的Arthas。这是一个java应用线上诊断工具。如果你之前用过Btrace，那么理解起来Arthas就不难。这两个都是java线上应用诊断工具。比如你想了解当前执行应用的内存占用，线程情况，具体参数值等信息，无需麻烦的打日志，上线就可以用上面的工具轻轻松松解决问题。

 之前也了解过Btrace，但是鉴于用起来太麻烦，一直不喜欢用。这次发现了Arthas，用起来简直不要太方便。这两个工具的功能类似，要说区别嘛举个例子对比就是：你把Btrace比作飞刀，如果你是李寻欢，那么凭借这把飞到什么妖魔鬼怪你都可以干掉。而Arthas理解为AK-47。拿着这玩意，我们普通人也可以横扫天下了😄。
<!--break-->

{% include JB/setup %}

为了让不了解Arthas的小伙伴不要太懵逼，下面先摘录Arthas官方的一段话来说明它能干嘛
```
当你遇到以下类似问题而束手无策时，Arthas可以帮助你解决：

- 这个类从哪个 jar 包加载的？为什么会报各种类相关的 Exception？
- 我改的代码为什么没有执行到？难道是我没 commit？分支搞错了？
- 遇到问题无法在线上 debug，难道只能通过加日志再重新发布吗？
- 线上遇到某个用户的数据处理有问题，但线上同样无法 debug，线下无法重现！
- 是否有一个全局视角来查看系统的运行状况？
- 有什么办法可以监控到JVM的实时运行状态？

Arthas支持JDK 6+，支持Linux/Mac/Winodws，采用命令行交互模式，同时提供丰富的 Tab 自动补全功能，进一步方便进行问题的定位和诊断。
```

怎么样？是不是小伙伴们的福音？下次系统再有问题，就可以不用麻烦运维哥哥一遍又一遍的发布打了一堆日志的应用了。

Arthas官方文档非常好用，小伙伴们可以点击这里查看使用：https://alibaba.github.io/arthas/

我这里仅记录下我最近使用它处理线上问题的经历，让你看看是不是很好用

最近产品妹妹提了个需求，要生成最近30天的每天的业务报表。在下一顿操作猛如虎，功能上线了，由于之前已经有个定时任务会自动生成每天的报表，所以，我在定时任务上加了个参数，可以指定具体日期，这样就胜场那天的报表。
在线上是我配置个参数：{"reportDate":"2019-08-05"}，执行后发现生成的不是8月5日的报表，而是生成了当天的，我程序里有判断如果没有传指定日期就生成当天的报表。但是我明明传了呀。
我排查问题的思路如下：
- 1,确保我新调整的代码上线了
- 2,确保我在页面设置的参数有传到指定的方法
- 3,那个方法我本地有做单元测试执行是没问题的，所以上面两步骤应该就可以查出问题了

那么针对第一个问题，以往我得解决办法是，直接把指定代码所在的jar包下载到本地，用反编译工具反编译代码后查看代码是否是我想要的，但是现在不用这么麻烦啦，
我直接用jad命令 就可以查看线上的源代码。
首先下载arthas工具，并启动
```
wget https://alibaba.github.io/arthas/arthas-boot.jar
java -jar arthas-boot.jar

```
启动后根据程序进程id选择要诊断的程序,然后使用jad命令加上类名(包括包名)就可以查看具体类的源码了。
```
jad  com.xxx.schedule.job.ReportJob
```
查看后发现代码是最新的，没问题

接下来进入第二步，既然代码没问题，那么难道是参数没有传进来？怎么办，以前的思路，只能在在代码里打印出来参数重新发布了。

但是现在不需要啦，一个watch命令就搞定，wtch可以监听指定方法里的参数，当这个方法执行的时候输出参数的信息
具体用法为：
```
watch com.xxx.schedule.job.ReportJob(类名) execute(方法名) params(表示监听该方法的参数)
```
然后我让定时任务重新执行了一遍。高潮来了，天，竟然参数也传过来了。参数也传过来，但是我程序依然没有用该参数，那是什么问题呢。难道是因为参数有问题？

赶紧爬到屏幕上仔细看了下参数，果然，一个惊天小问题：
参数是json格式的，json里面双引号应该是半角的，我把其中一个双引号写成全角的了，不仔细看还真看不出来。
```
{"reportDate","2019-08-05"}
{“reportDate","2019-08-05"}
```

怎么样，忽略我的粗心大意之后，剩下的——Arthas是不是很好用！！！
